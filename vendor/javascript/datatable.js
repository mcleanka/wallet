import e from"underscore";var r={};var a=e;var t=100;r=function(e){var r={sTableName:e.sTableName,sCountColumnName:e.sCountColumnName,sDatabaseOrSchema:e.sDatabaseOrSchema,aSearchColumns:e.aSearchColumns||[],sSelectSql:e.sSelectSql,sFromSql:e.sFromSql,sWhereAndSql:e.sWhereAndSql,sDateColumnName:e.sDateColumnName,dateFrom:e.dateFrom,dateTo:e.dateTo,oRequestQuery:e.oRequestQuery,sAjaxDataProp:"data",dbType:e.dbType,buildQuery:buildQuery,parseResponse:parseResponse,extractResponseVal:extractResponseVal,filteredResult:filteredResult};function buildSetDatabaseOrSchemaStatement(){if(r.sDatabaseOrSchema)return"oracle"===r.dbType?"ALTER SESSION SET CURRENT_SCHEMA = "+r.sDatabaseOrSchema:"USE "+r.sDatabaseOrSchema}function buildDatePartial(){if(r.sDateColumnName&&r.dateFrom||r.dateTo){if(r.dateFrom&&r.dateTo)return r.sDateColumnName+" BETWEEN '"+r.dateFrom.toISOString()+"' AND '"+r.dateTo.toISOString()+"'";if(r.dateFrom)return r.sDateColumnName+" >= '"+r.dateFrom.toISOString()+"'";if(r.dateTo)return r.sDateColumnName+" <= '"+r.dateTo.toISOString()+"'"}}function buildCountStatement(e){var a=buildDatePartial();var t="SELECT COUNT(";t+=r.sSelectSql?"*":r.sCountColumnName?r.sCountColumnName:"id";t+=") FROM ";t+=r.sFromSql?r.sFromSql:r.sTableName;t+=buildWherePartial(e);return t}function buildWherePartial(e){var a=[];var t=buildSearchPartial(e);t&&a.push(t);r.sWhereAndSql&&a.push(r.sWhereAndSql);var n=buildDatePartial();n&&a.push(n);return a.length?" WHERE ("+a.join(") AND (")+")":""}function buildSearchPartial(e){var r=[],a=buildSearchArray(e),t=buildSearchArray(e,true);a.length&&r.push("("+a.join(" AND ")+")");t.length&&r.push("("+t.join(" OR ")+")");return r.join(" AND ")}function buildSearchArray(e,t){var n=[],s=a.isArray(r.aSearchColumns)&&!a.isEmpty(r.aSearchColumns)&&t;a.each(s?r.aSearchColumns:e.columns,(function(a){if(s||"true"===a.searchable){var l=sanitize(s?a:a.name),u=sanitize(t?e.search.value:a.search.value);l&&u&&n.push("postgres"===r.dbType?buildILIKESearch(l,u):buildLIKESearch(l,u))}}));return n}function buildILIKESearch(e,r){return"CAST("+e+" as text)"+" ILIKE '%"+r+"%'"}function buildLIKESearch(e,r){return e+" LIKE '%"+r+"%'"}function buildOrderingPartial(e){var r=[];for(var t=0;t<a.isArray(e.order)?e.order.length:0;++t){var n=e.order[t],s=e.columns[n.column];"true"===s.orderable&&s.name&&r.push(s.name+" "+n.dir)}return r.length?" ORDER BY "+r.join(", "):""}function buildLimitPartial(e){var a="";if(e&&void 0!==e.start&&"oracle"!==r.dbType){var n=parseInt(e.start,10);if(n>=0){var s=parseInt(e.length,10);a="postgres"===r.dbType?" OFFSET "+String(n)+" LIMIT ":" LIMIT "+String(n)+", ";a+=String(s>0?s:t)}}return a}function buildSelectPartial(){var e="SELECT ";e+=r.sSelectSql?r.sSelectSql:"*";e+=" FROM ";e+=r.sFromSql?r.sFromSql:r.sTableName;return e}function buildQuery(e){var t={};if("object"!==typeof e)return t;var n=sanitize(a.isObject(e.search)?e.search.value:"");r.oRequestQuery=e;var s=buildSetDatabaseOrSchemaStatement();s&&(t.changeDatabaseOrSchema=s);t.recordsTotal=buildCountStatement(e);n&&(t.recordsFiltered=buildCountStatement(e));var l=buildSelectPartial();l+=buildWherePartial(e);l+=buildOrderingPartial(e);l+=buildLimitPartial(e);if("oracle"===r.dbType){var u=parseInt(e.start,10);var i=parseInt(e.length,10);if(i>=0&&u>=0){l="SELECT * FROM (SELECT a.*, ROWNUM rnum FROM ("+l+") ";l+="a)"+" WHERE rnum BETWEEN "+(u+1)+" AND "+(u+i)}}t.select=l;return t}function parseResponse(e){var t=r.oRequestQuery;var n={recordsFiltered:0,recordsTotal:0};t&&"string"===typeof t.draw?n.draw=parseInt(t.draw,10):n.draw=0;if(a.isObject(e)&&a.keys(e).length>1){n.recordsFiltered=n.recordsTotal=extractResponseVal(e.recordsTotal)||0;e.recordsFiltered&&(n.recordsFiltered=extractResponseVal(e.recordsFiltered)||0);n.data=e.select}return n}function extractResponseVal(e){if(a.isArray(e)&&e.length&&a.isObject(e[0])){var r=a.values(e[0]);if(r.length)return r[0]}}function filteredResult(e,t){if(e){var n=a.omit(e,r.sAjaxDataProp);n.aaLength=e[r.sAjaxDataProp]?e[r.sAjaxDataProp].length:0;n[r.sAjaxDataProp]=[];var t=t?Math.min(t,n.aaLength):n.aaLength;for(var s=0;s<t;++s)n[r.sAjaxDataProp].push(e[r.sAjaxDataProp][s]);return n}return null}return r};function sanitize(e,r){r=r||256;return!e||"string"===typeof e&&e.length<1?e:"string"!==typeof e||e.length>r?null:e.replace(/[\0\x08\x09\x1a\n\r"'\\\%]/g,(function(e){switch(e){case"\0":return"\\0";case"\b":return"\\b";case"\t":return"\\t";case"":return"\\z";case"\n":return"\\n";case"\r":return"\\r";case'"':case"'":case"\\":case"%":return"\\"+e}}))}var n=r;export default n;

